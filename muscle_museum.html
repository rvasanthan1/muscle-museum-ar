<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Microscopic Giants: Muscle Adaptation</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls for Three.js (using unpkg for consistency) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- FontLoader for Three.js TextGeometry (using unpkg for consistency) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FontLoader.js"></script>
    <!-- TextGeometry for Three.js (using unpkg for consistency) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/TextGeometry.js"></script>
    <!-- Lucide React Icons (inline SVG generation) -->
    <script src="https://unpkg.com/lucide-react@0.395.0/dist/lucide-react.umd.js"></script>

    <style>
        /* Global styles for the body and font */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent scrolling */
            background-color: #1a202c; /* Dark background for consistency */
        }
        /* Ensure the canvas fills its container */
        #scene-container {
            display: block;
            width: 100%;
            height: 100%;
            /* Temporary background for debugging scene-container visibility */
            background-color: #333; /* Dark gray to make it visible */
        }
        #scene-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        /* Keyframe animation for fade-in effect */
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out forwards;
        }
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Helper function to create a single myofiber with its myonuclei and satellite cells
        const createMyofiberHelper = (THREE, x, y, z, id) => {
            const fiberGeometry = new THREE.CylinderGeometry(0.05, 0.05, 1, 8);
            const fiberMaterial = new THREE.MeshPhongMaterial({ color: 0xADD8E6 }); // Light blue for quiescent
            const fiber = new THREE.Mesh(fiberGeometry, fiberMaterial);
            fiber.position.set(x, y, z);
            fiber.rotation.z = Math.PI / 2; // Lay horizontally
            fiber.userData = { type: 'myofiber', id: `fiber-${id}`, originalScale: fiber.scale.clone() };

            // Myonuclei - position relative to the fiber's local origin (0,0,0)
            const myonucleusGeometry = new THREE.SphereGeometry(0.02, 8, 8);
            const myonucleusMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFF00, emissive: 0xFFFF00, emissiveIntensity: 0.5 }); // Glowing orb
            for (let i = 0; i < 3; i++) { // Initial 3 myonuclei
                const myonucleus = new THREE.Mesh(myonucleusGeometry, myonucleusMaterial);
                // Position relative to the fiber's local space
                myonucleus.position.set((i - 1) * 0.2, 0, 0.05);
                myonucleus.userData = { type: 'myonucleus', parentFiberId: fiber.userData.id };
                fiber.add(myonucleus);
            }

            // Satellite Cells - position relative to the fiber's local origin (0,0,0)
            const satelliteCellGeometry = new THREE.SphereGeometry(0.03, 8, 8);
            const satelliteCellMaterial = new THREE.MeshBasicMaterial({ color: 0x90EE90, emissive: 0x90EE90, emissiveIntensity: 0.3 }); // Dormant green
            const satelliteCell = new THREE.Mesh(satelliteCellGeometry, satelliteCellMaterial);
            // Position relative to the fiber's local space
            satelliteCell.position.set(-0.3, 0.07, 0);
            satelliteCell.userData = { type: 'satelliteCell', parentFiberId: fiber.userData.id, active: false };
            fiber.add(satelliteCell);

            return fiber;
        };


        // Main App Component
        const App = () => {
            const [currentPhase, setCurrentPhase] = React.useState('initial'); // 'initial', 'stimulus', 'adaptation', 'result'
            const [adaptationPathway, setAdaptationPathway] = React.useState(null); // 'hypertrophy', 'hyperplasia'
            const [animationSpeed, setAnimationSpeed] = React.useState(1);
            const [isZoomedIn, setIsZoomedIn] = React.useState(false);
            const [myofiberCount, setMyofiberCount] = React.useState(10); // Initial count
            const [showInfo, setShowInfo] = React.useState(''); // Stores the current info message
            const [icons, setIcons] = React.useState({}); // State to hold Lucide React icons
            const [fontLoaded, setFontLoaded] = React.useState(false); // New state for font loading
            const [lucideIconsLoaded, setLucideIconsLoaded] = React.useState(false); // New state for Lucide icons loading

            const sceneRef = React.useRef();
            const cameraRef = React.useRef();
            const rendererRef = React.useRef();
            const controlsRef = React.useRef();
            const armModelRef = React.useRef(new THREE.Group()); // Group for the arm model
            const muscleFibersGroupRef = React.useRef(new THREE.Group()); // Group for microscopic muscle fibers
            const raycasterRef = React.useRef(new THREE.Raycaster());
            const mouseRef = React.useRef(new THREE.Vector2());
            const animationFrameId = React.useRef(null);
            const fontRef = React.useRef(null);
            const textMeshesRef = React.useRef([]);
            const sceneContainerRef = React.useRef(null); // New ref for the scene container

            // Ref to store current animation state to prevent stale closures
            const animationStateRef = React.useRef({ currentPhase, adaptationPathway, animationSpeed });
            React.useEffect(() => {
                animationStateRef.current = { currentPhase, adaptationPathway, animationSpeed };
            }, [currentPhase, adaptationPathway, animationSpeed]);


            // Load Lucide React icons once the script is available
            React.useEffect(() => {
                console.log('Attempting to load Lucide React icons...');
                if (window.lucideReact) {
                    const { Circle, Play, Pause, FastForward, Rewind, ZoomIn, ZoomOut, Info, Divide, Plus, Scale, ArrowLeftRight, Activity } = window.lucideReact;
                    setIcons({ Circle, Play, Pause, FastForward, Rewind, ZoomIn, ZoomOut, Info, Divide, Plus, Scale, ArrowLeftRight, Activity });
                    setLucideIconsLoaded(true); // Set state to true on success
                    console.log('Lucide React icons loaded successfully.');
                } else {
                    console.warn('lucideReact not found on window object. Icons will not be displayed.');
                    setLucideIconsLoaded(false); // Set state to false on failure
                }
            }, []);


            // Load font for 3D text
            React.useEffect(() => {
                console.log('Loading font...');
                const loader = new THREE.FontLoader();
                loader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/fonts/helvetiker_regular.typeface.json', (font) => {
                    fontRef.current = font;
                    setFontLoaded(true); // Set fontLoaded to true on success
                    console.log('Font loaded successfully.');
                }, undefined, (error) => {
                    console.error('Error loading font:', error);
                    setFontLoaded(false); // Set fontLoaded to false on error
                });
            }, []);

            // Function to create 3D text
            const createText = React.useCallback((text, position, color = 0xffffff, size = 0.5) => {
                if (!fontRef.current) {
                    console.warn('Font not loaded yet, cannot create text:', text);
                    return null;
                }
                const geometry = new THREE.TextGeometry(text, {
                    font: fontRef.current,
                    size: size,
                    height: 0.05,
                    curveSegments: 12,
                    bevelEnabled: true,
                    bevelThickness: 0.01,
                    bevelSize: 0.01,
                    bevelOffset: 0,
                    bevelSegments: 5
                });
                geometry.computeBoundingBox();
                const material = new THREE.MeshBasicMaterial({ color: color });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(position.x, position.y, position.z);
                sceneRef.current.add(mesh);
                textMeshesRef.current.push(mesh);
                console.log('Created 3D text:', text);
                return mesh;
            }, []);

            // Scene Initialization - This useEffect now runs only when sceneContainerRef.current becomes available
            React.useEffect(() => {
                // This check is crucial: ensure the ref is populated before proceeding
                if (!sceneContainerRef.current) {
                    console.log('Three.js init: Scene container ref not yet available. Waiting...');
                    return; // Exit if ref is not ready
                }

                console.log('Initializing Three.js scene...');
                const scene = new THREE.Scene();
                sceneRef.current = scene;

                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 2, 5); // Initial camera position
                cameraRef.current = camera;
                console.log('Camera initialized.');

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x000000, 0); // Transparent background
                
                // Append the renderer's DOM element to the scene container
                sceneContainerRef.current.appendChild(renderer.domElement);
                console.log('Renderer DOM element appended to scene-container.');
                
                rendererRef.current = renderer;

                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.screenSpacePanning = false;
                controls.maxPolarAngle = Math.PI / 2;
                controlsRef.current = controls;
                console.log('OrbitControls initialized.');

                // Add ambient light
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);

                // Add directional light
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(5, 10, 7);
                scene.add(directionalLight);
                console.log('Lights added.');

                // Initial Arm Model (simplified)
                const armGeometry = new THREE.CylinderGeometry(0.5, 0.8, 3, 32);
                const armMaterial = new THREE.MeshPhongMaterial({ color: 0x808080, transparent: true, opacity: 0.4 });
                const arm = new THREE.Mesh(armGeometry, armMaterial);
                arm.position.set(0, 1.5, 0);
                armModelRef.current.add(arm);

                // Biceps (highlighted part)
                const bicepsGeometry = new THREE.SphereGeometry(0.7, 32, 32);
                const bicepsMaterial = new THREE.MeshPhongMaterial({ color: 0x8B0000, transparent: true, opacity: 0.6 });
                const biceps = new THREE.Mesh(bicepsGeometry, bicepsMaterial);
                biceps.position.set(0, 2.5, 0);
                armModelRef.current.add(biceps);
                armModelRef.current.name = 'arm'; // Name for raycasting

                scene.add(armModelRef.current);
                console.log('Arm model added.');

                // Create initial myofibers
                for (let i = 0; i < 5; i++) {
                    for (let j = 0; j < 2; j++) {
                        const fiber = createMyofiberHelper(THREE, (i - 2) * 1.2, (j - 0.5) * 0.2, 0, `${i}-${j}`);
                        muscleFibersGroupRef.current.add(fiber);
                    }
                }
                muscleFibersGroupRef.current.position.set(0, 0, 0); // Center the group
                muscleFibersGroupRef.current.scale.set(0.1, 0.1, 0.1); // Start small, will scale up on zoom
                scene.add(muscleFibersGroupRef.current);
                muscleFibersGroupRef.current.visible = false; // Hidden initially
                console.log('Muscle fibers added.');

                // Handle window resize
                const handleResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    console.log('Window resized.');
                };
                window.addEventListener('resize', handleResize);

                // Animation loop (defined inside useEffect to capture current state variables)
                const animate = () => {
                    animationFrameId.current = requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                    
                    // Use animationStateRef.current to get the latest state values
                    const { currentPhase: latestPhase, adaptationPathway: latestPathway, animationSpeed: latestSpeed } = animationStateRef.current;

                    // Update text meshes to face camera
                    textMeshesRef.current.forEach(mesh => {
                        if (cameraRef.current) { // Ensure camera is available before copying quaternion
                            mesh.quaternion.copy(cameraRef.current.quaternion);
                        }
                    });

                    // Specific animations based on phase
                    if (latestPhase === 'stimulus') {
                        // Animate biceps curl (simplified rotation)
                        armModelRef.current.rotation.x = Math.sin(Date.now() * 0.001 * latestSpeed) * 0.5;
                        // Animate micro-tears (visual effect on fibers)
                        muscleFibersGroupRef.current.children.forEach(fiber => {
                            if (fiber.userData.type === 'myofiber') {
                                fiber.material.color.setHex(0xFF4500); // Orange-red for stress
                                if (Math.random() < 0.01 * latestSpeed) { // Randomly show micro-tears
                                    fiber.material.emissive.setHex(0xFF0000); // Red glow
                                    fiber.material.emissiveIntensity = 0.5;
                                } else {
                                    fiber.material.emissiveIntensity = 0;
                                }
                            }
                        });
                    } else if (latestPhase === 'adaptation') {
                        if (latestPathway === 'hypertrophy') {
                            muscleFibersGroupRef.current.children.forEach(fiber => {
                                if (fiber.userData.type === 'myofiber') {
                                    // Protein synthesis: fiber visibly thicker
                                    fiber.scale.lerp(new THREE.Vector3(fiber.userData.originalScale.x * 1.5, fiber.userData.originalScale.y * 1.5, fiber.userData.originalScale.z), 0.005 * latestSpeed);
                                    fiber.material.color.setHex(0x00BFFF); // Deep blue for growth

                                    // Satellite cell activation and fusion (simplified visual)
                                    fiber.children.forEach(child => {
                                        if (child.userData.type === 'satelliteCell' && !child.userData.active) {
                                            child.material.emissive.setHex(0x00FF00); // Bright green
                                            child.material.emissiveIntensity = 1;
                                            child.userData.active = true; // Mark as active

                                            // Simulate fusion by adding a new myonucleus
                                            if (Math.random() < 0.005 * latestSpeed) {
                                                const newMyonucleus = new THREE.Mesh(
                                                    new THREE.SphereGeometry(0.02, 8, 8),
                                                    new THREE.MeshBasicMaterial({ color: 0xFFFF00, emissive: 0xFFFF00, emissiveIntensity: 0.8 })
                                                );
                                                // Position relative to the fiber
                                                newMyonucleus.position.set(Math.random() * 0.4 - 0.2, 0, 0.05);
                                                newMyonucleus.userData = { type: 'myonucleus', parentFiberId: fiber.userData.id, id: `dynamic-myonucleus-${Date.now()}-${Math.random()}` };
                                                fiber.add(newMyonucleus);
                                            }
                                        }
                                    });
                                }
                            });
                        } else if (latestPathway === 'hyperplasia') {
                            muscleFibersGroupRef.current.children.forEach(fiber => {
                                if (fiber.userData.type === 'myofiber') {
                                    fiber.material.color.setHex(0x8A2BE2); // Purple for hyperplasia

                                    // Simulate fiber splitting (visually by creating new smaller fibers)
                                    if (fiber.userData.id.includes('split') === false && Math.random() < 0.002 * latestSpeed) {
                                        const newFiber1 = fiber.clone();
                                        newFiber1.scale.set(fiber.scale.x * 0.7, fiber.scale.y * 0.7, fiber.scale.z);
                                        newFiber1.position.x -= 0.1;
                                        newFiber1.userData.id += '-split1';
                                        muscleFibersGroupRef.current.add(newFiber1);

                                        const newFiber2 = fiber.clone();
                                        newFiber2.scale.set(fiber.scale.x * 0.7, fiber.scale.y * 0.7, fiber.scale.z);
                                        newFiber2.position.x += 0.1;
                                        newFiber2.userData.id += '-split2';
                                        muscleFibersGroupRef.current.add(newFiber2);

                                        fiber.visible = false; // Hide original to simulate split
                                        setMyofiberCount(prev => prev + 2); // Increase count
                                    }

                                    // Simulate new fiber formation from satellite cells (visually by creating new fibers)
                                    fiber.children.forEach(child => {
                                        if (child.userData.type === 'satelliteCell' && !child.userData.active) {
                                            child.material.emissive.setHex(0x00FF00); // Bright green
                                            child.material.emissiveIntensity = 1;
                                            child.userData.active = true;

                                            if (Math.random() < 0.001 * latestSpeed) {
                                                const newFiber = createMyofiberHelper(
                                                    THREE,
                                                    fiber.position.x + Math.random() * 0.5 - 0.25,
                                                    fiber.position.y + Math.random() * 0.5 - 0.25,
                                                    fiber.position.z,
                                                    `new-${Date.now()}`
                                                );
                                                newFiber.scale.set(fiber.userData.originalScale.x * 0.5, fiber.userData.originalScale.y * 0.5, fiber.userData.originalScale.z);
                                                muscleFibersGroupRef.current.add(newFiber);
                                                setMyofiberCount(prev => prev + 1);
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    } else if (latestPhase === 'result') {
                        // Final state: larger and/or more fibers, calm environment
                        armModelRef.current.rotation.x = 0; // Stop curl animation
                        muscleFibersGroupRef.current.children.forEach(fiber => {
                            if (fiber.userData.type === 'myofiber') {
                                fiber.material.color.setHex(0xADD8E6); // Back to calm blue
                                fiber.material.emissiveIntensity = 0;
                                fiber.children.forEach(child => {
                                    if (child.userData.type === 'satelliteCell') {
                                        child.material.emissiveIntensity = 0.3; // Back to dormant
                                    }
                                });
                            }
                        });
                    } else { // Initial state
                        armModelRef.current.rotation.x = 0;
                        muscleFibersGroupRef.current.children.forEach(fiber => {
                            if (fiber.userData.type === 'myofiber') {
                                fiber.material.color.setHex(0xADD8E6); // Light blue for quiescent
                                fiber.material.emissiveIntensity = 0;
                                fiber.children.forEach(child => {
                                    if (child.userData.type === 'satelliteCell') {
                                        child.material.emissiveIntensity = 0.3; // Dormant green
                                    }
                                    if (child.userData.type === 'myonucleus') {
                                        child.material.emissiveIntensity = 0.5; // Glowing orb
                                    }
                                });
                                fiber.scale.copy(fiber.userData.originalScale); // Reset size
                            }
                        });
                    }
                };

                animate();
                console.log('Animation loop started.');

                return () => {
                    console.log('Cleaning up Three.js scene...');
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(animationFrameId.current);
                    if (rendererRef.current && rendererRef.current.domElement) {
                        rendererRef.current.domElement.remove();
                    }
                    scene.remove(armModelRef.current);
                    // Dispose of geometries and materials to prevent memory leaks
                    muscleFibersGroupRef.current.children.forEach(obj => {
                        obj.traverse(child => {
                            if (child.geometry) child.geometry.dispose();
                            if (child.material) {
                                if (Array.isArray(child.material)) {
                                    child.material.forEach(material => material.dispose());
                                } else {
                                    child.material.dispose();
                                }
                            }
                        });
                    });
                    scene.remove(muscleFibersGroupRef.current); // Remove the group itself
                    controls.dispose();
                    renderer.dispose();
                    console.log('Three.js scene cleaned up.');
                };
            }, [sceneContainerRef.current]); // Only run this effect when the ref itself changes (i.e., on mount)


            // Handle user clicks/taps on 3D objects
            const onCanvasClick = React.useCallback((event) => {
                // Ensure camera and muscle group are ready and have children to intersect with
                if (!cameraRef.current || !muscleFibersGroupRef.current || !muscleFibersGroupRef.current.children || muscleFibersGroupRef.current.children.length === 0) {
                    console.warn("Camera, muscle fibers group, or its children not ready for click handling.");
                    setShowInfo(''); // Clear any old info
                    return;
                }

                // Calculate mouse position in normalized device coordinates (-1 to +1)
                mouseRef.current.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouseRef.current.y = -(event.clientY / window.innerHeight) * 2 + 1;

                // Set raycaster from camera and mouse position
                raycasterRef.current.setFromCamera(mouseRef.current, cameraRef.current); 

                // Intersect with all children of muscleFibersGroupRef.current, including nested children
                const intersects = raycasterRef.current.intersectObjects(muscleFibersGroupRef.current.children, true);

                textMeshesRef.current.forEach(mesh => sceneRef.current.remove(mesh));
                textMeshesRef.current = []; // Clear previous labels

                if (intersects.length > 0) {
                    const intersectedObject = intersects[0].object;

                    // CRITICAL CHECK: Ensure intersectedObject is a valid Three.js Object3D instance AND has a position property
                    // Also check if it has userData, as we rely on it for our logic
                    if (!(intersectedObject instanceof THREE.Object3D) || !intersectedObject.position || !intersectedObject.userData) {
                        console.error("Intersected object is invalid or does not have expected properties:", intersectedObject);
                        setShowInfo('');
                        return; // Prevent further errors
                    }

                    // Get the world position of the intersected object for label placement
                    const labelPosition = new THREE.Vector3();
                    intersectedObject.getWorldPosition(labelPosition);

                    const userData = intersectedObject.userData;
                    console.log('Object clicked:', userData.type, userData.id);

                    if (userData.type === 'myofiber') {
                        setShowInfo('Myofiber (Muscle Fiber)');
                        createText('Myofiber (Muscle Fiber)', labelPosition.add(new THREE.Vector3(0.2, 0.2, 0)));
                    } else if (userData.type === 'myonucleus') {
                        setShowInfo('Myonucleus: Controls protein synthesis.');
                        createText('Myonucleus: Controls protein synthesis.', labelPosition.add(new THREE.Vector3(0.05, 0.05, 0)));
                    } else if (userData.type === 'satelliteCell') {
                        setShowInfo('Satellite Cell: A muscle stem cell, currently inactive.');
                        if (currentPhase === 'adaptation' && userData.active) {
                            setShowInfo('Satellite Cell: Activated and contributing to muscle growth!');
                        }
                        createText('Satellite Cell: A muscle stem cell', labelPosition.add(new THREE.Vector3(0.05, 0.05, 0)));
                    } else if (currentPhase === 'stimulus' && (userData.type === 'myofiber' || (intersectedObject.parent && intersectedObject.parent.userData.type === 'myofiber'))) {
                        // This block handles clicks on the fiber itself or its direct children during stimulus
                        setShowInfo('Controlled micro-damage from resistance training is a key trigger for muscle growth.');
                        createText('Micro-damage!', labelPosition.add(new THREE.Vector3(0.2, 0.2, 0)));
                    }
                } else {
                    setShowInfo(''); // Clear info if no object is hit
                    console.log('No 3D object clicked.');
                }
            }, [currentPhase, createText]);

            React.useEffect(() => {
                const canvas = rendererRef.current?.domElement;
                if (canvas) {
                    canvas.addEventListener('click', onCanvasClick);
                    console.log('Click listener added to canvas.');
                    return () => {
                        canvas.removeEventListener('click', onCanvasClick);
                        console.log('Click listener removed from canvas.');
                    };
                }
            }, [onCanvasClick]);

            // Camera and model transitions based on zoom state
            React.useEffect(() => {
                if (!cameraRef.current || !controlsRef.current || !armModelRef.current || !muscleFibersGroupRef.current) {
                    console.warn("Camera or models not ready for zoom transition.");
                    return;
                }

                if (isZoomedIn) {
                    // Zoom into microscopic view
                    cameraRef.current.position.set(0, 0, 1.5);
                    controlsRef.current.target.set(0, 0, 0);
                    armModelRef.current.visible = false;
                    muscleFibersGroupRef.current.visible = true;
                    muscleFibersGroupRef.current.scale.set(1, 1, 1); // Scale up to normal size
                    console.log('Zoomed in to microscopic view.');
                } else {
                    // Zoom out to arm view
                    cameraRef.current.position.set(0, 2, 5);
                    controlsRef.current.target.set(0, 1.5, 0);
                    armModelRef.current.visible = true;
                    muscleFibersGroupRef.current.visible = false;
                    console.log('Zoomed out to arm view.');
                }
                controlsRef.current.update();
            }, [isZoomedIn]);

            // Reset scene state
            const resetScene = React.useCallback(() => {
                console.log('Resetting scene...');
                setCurrentPhase('initial');
                setAdaptationPathway(null);
                setIsZoomedIn(false);
                setMyofiberCount(10);
                setShowInfo('');

                // Dispose of geometries and materials and remove all children from the group
                if (muscleFibersGroupRef.current) { // Ensure group exists before trying to clear
                    while(muscleFibersGroupRef.current.children.length > 0){
                        const object = muscleFibersGroupRef.current.children[0];
                        object.traverse(child => {
                            if (child.geometry) child.geometry.dispose();
                            if (child.material) {
                                if (Array.isArray(child.material)) {
                                    child.material.forEach(material => material.dispose());
                                } else {
                                    child.material.dispose();
                                }
                            }
                        });
                        muscleFibersGroupRef.current.remove(object);
                    }
                }
                
                textMeshesRef.current.forEach(mesh => sceneRef.current.remove(mesh));
                textMeshesRef.current = []; // Clear all 3D text labels

                // Re-create initial myofibers
                for (let i = 0; i < 5; i++) {
                    for (let j = 0; j < 2; j++) {
                        const fiber = createMyofiberHelper(THREE, (i - 2) * 1.2, (j - 0.5) * 0.2, 0, `${i}-${j}`);
                        muscleFibersGroupRef.current.add(fiber);
                    }
                }
                console.log('Scene reset complete with initial fibers re-created.');

            }, []);

            const handleStartTraining = () => {
                setCurrentPhase('stimulus');
                setIsZoomedIn(true); // Auto-zoom into microscopic view
                console.log('Starting strength training phase.');
            };

            const handleSelectHypertrophy = () => {
                setAdaptationPathway('hypertrophy');
                setCurrentPhase('adaptation');
                console.log('Selected Hypertrophy pathway.');
            };

            const handleSelectHyperplasia = () => {
                setAdaptationPathway('hyperplasia');
                setCurrentPhase('adaptation');
                console.log('Selected Hyperplasia pathway.');
            };

            const handleShowResult = () => {
                setCurrentPhase('result');
                setIsZoomedIn(false); // Zoom out to see the larger arm
                console.log('Showing result phase.');
            };

            // Render null or a loading indicator if icons or font are not yet loaded
            if (!lucideIconsLoaded || !fontLoaded) {
                return (
                    <div className="relative w-screen h-screen flex items-center justify-center bg-gray-900 text-white">
                        <p className="text-xl">Loading interactive museum scene...</p>
                    </div>
                );
            }

            // Destructure icons from the state for easier use in JSX
            const { Circle, Play, Pause, FastForward, Rewind, ZoomIn, ZoomOut, Info, Divide, Plus, Scale, ArrowLeftRight, Activity } = icons;

            return (
                <div className="relative w-screen h-screen overflow-hidden font-inter bg-gray-900 text-white">
                    {/* Scene Container - This is where the Three.js canvas will be appended */}
                    {/* Attach the ref to the div */}
                    <div id="scene-container" ref={sceneContainerRef} className="absolute inset-0 z-0"></div>

                    {/* UI Overlay - This will appear on top of the Three.js scene */}
                    <div className="relative z-10 p-4 flex flex-col h-full">
                        {/* Header */}
                        <div className="text-center mb-4">
                            <h1 className="text-3xl md:text-4xl font-bold text-blue-300 drop-shadow-lg">The Microscopic Giants</h1>
                            <p className="text-md md:text-lg text-gray-300">Building Muscle with Strength Training</p>
                        </div>

                        {/* Info Panel */}
                        {showInfo && (
                            <div className="absolute top-4 right-4 bg-gradient-to-br from-blue-700 to-purple-800 text-white p-3 rounded-lg shadow-xl max-w-xs md:max-w-sm text-sm md:text-base animate-fade-in-down">
                                <p>{showInfo}</p>
                            </div>
                        )}

                        {/* Main Controls */}
                        <div className="flex-grow flex items-center justify-center">
                            <div className="flex flex-col space-y-4 p-6 bg-gray-800 bg-opacity-80 rounded-xl shadow-2xl border border-gray-700">
                                {currentPhase === 'initial' && (
                                    <>
                                        <button
                                            onClick={() => setIsZoomedIn(!isZoomedIn)}
                                            className="flex items-center justify-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                                        >
                                            {lucideIconsLoaded ? <ZoomIn className="mr-2" /> : null}
                                            {isZoomedIn ? 'Zoom Out to Arm' : 'Zoom In to Muscle'}
                                        </button>
                                        <button
                                            onClick={handleStartTraining}
                                            className="flex items-center justify-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75"
                                        >
                                            {lucideIconsLoaded ? <Play className="mr-2" /> : null}
                                            Start Strength Training
                                        </button>
                                    </>
                                )}

                                {currentPhase === 'stimulus' && (
                                    <>
                                        <div className="text-center text-lg text-yellow-300">Muscle Under Stress!</div>
                                        <div className="flex space-x-2">
                                            <button
                                                onClick={() => setAnimationSpeed(0.5)}
                                                className="flex items-center justify-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                                            >
                                                {lucideIconsLoaded ? <Rewind className="mr-1" size={18} /> : null} Slow
                                            </button>
                                            <button
                                                onClick={() => setAnimationSpeed(1)}
                                                className="flex items-center justify-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                                            >
                                                {lucideIconsLoaded ? <Play className="mr-1" size={18} /> : null} Normal
                                            </button>
                                            <button
                                                onClick={() => setAnimationSpeed(2)}
                                                className="flex items-center justify-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                                            >
                                                {lucideIconsLoaded ? <FastForward className="mr-1" size={18} /> : null} Fast
                                            </button>
                                        </div>
                                        <button
                                            onClick={() => setCurrentPhase('adaptation')}
                                            className="flex items-center justify-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75"
                                        >
                                            {lucideIconsLoaded ? <Activity className="mr-2" /> : null}
                                            Proceed to Adaptation
                                        </button>
                                    </>
                                )}

                                {currentPhase === 'adaptation' && (
                                    <>
                                        <div className="text-center text-lg text-cyan-300">Choose Adaptation Pathway:</div>
                                        <button
                                            onClick={handleSelectHypertrophy}
                                            className={`flex items-center justify-center px-6 py-3 font-semibold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-75 ${adaptationPathway === 'hypertrophy' ? 'bg-blue-800' : 'bg-blue-600 hover:bg-blue-700'} text-white`}
                                        >
                                            {lucideIconsLoaded ? <Scale className="mr-2" /> : null}
                                            Pathway A: Hypertrophy (Bigger)
                                        </button>
                                        <button
                                            onClick={handleSelectHyperplasia}
                                            className={`flex items-center justify-center px-6 py-3 font-semibold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-75 ${adaptationPathway === 'hyperplasia' ? 'bg-purple-800' : 'bg-purple-600 hover:bg-purple-700'} text-white`}
                                        >
                                            {lucideIconsLoaded ? <Plus className="mr-2" /> : null}
                                            Pathway B: Hyperplasia (More Fibers)
                                        </button>
                                        {adaptationPathway && (
                                            <button
                                                onClick={handleShowResult}
                                                className="flex items-center justify-center px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75"
                                        >
                                            {lucideIconsLoaded ? <ArrowLeftRight className="mr-2" /> : null}
                                            Show Result
                                        </button>
                                    )}
                                </>
                            )}

                            {currentPhase === 'result' && (
                                <>
                                    <div className="text-center text-lg text-lime-300">Muscle Adapted!</div>
                                    <div className="bg-gray-700 p-4 rounded-lg shadow-inner text-sm md:text-base">
                                        <h3 className="font-bold mb-2">Summary:</h3>
                                        <p className="mb-1">
                                            <span className="font-semibold text-blue-400">Hypertrophy:</span> Muscle fibers grow larger in diameter due to increased protein synthesis and myonuclei.
                                        </p>
                                        <p>
                                            <span className="font-semibold text-purple-400">Hyperplasia:</span> Total number of muscle fibers increases through splitting or new fiber formation.
                                        </p>
                                    </div>
                                    <button
                                        onClick={resetScene}
                                        className="flex items-center justify-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75"
                                    >
                                        {lucideIconsLoaded ? <Circle className="mr-2" /> : null}
                                        Reset Scene
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {/* Myofiber Count Display */}
                    {isZoomedIn && (
                        <div className="absolute bottom-4 left-4 bg-gray-800 bg-opacity-70 text-white p-3 rounded-lg shadow-lg text-sm md:text-base">
                            Total Myofiber Count: <span className="font-bold text-yellow-400">{myofiberCount}</span>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // Render the React application
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
</script>
</body>
</html>
